<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Substitute">
    <meta name="theme-color" content="#AF69EE">
    <title>Substitute</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Poppins', Arial, sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: #181826;
            color: #ffffff;
        }

        .app-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 15vh;
            background-color: #2a2a3c;
            display: flex;
            align-items: center;
            padding: 10px;
            z-index: 10;
        }

        .app-bar .logo {
            width: 60px;
            height: 60px;
            background-color: #AF69EE;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-left: 10px;
        }

        .app-bar .title {
            font-size: 24px;
            font-family: 'Crackman', serif;
            flex: 1;
            text-align: center;
            margin-right: 60px;
            color: #AF69EE;
        }

        .app-bar .menu-btn {
            position: absolute;
            right: 20px;
            color: #ccc;
        }

        .content {
            margin: 15vh 0 10vh 0;
            background-color: #1e1e2e;
            border-radius: 45px 45px 0 0;
            padding: 20px;
            min-height: calc(75vh);
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 10vh;
            background-color: #2a2a3c;
            border-radius: 30px 30px 0 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding-bottom: 10px;
        }

        .nav-item {
            text-align: center;
            color: #ccc;
            flex: 1;
        }

        .nav-item.active {
            color: #AF69EE;
        }

        .nav-icon {
            font-size: 24px;
            display: block;
            margin-bottom: 5px;
        }

        .form-container {
            max-width: 400px;
            margin: 0 auto;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background-color: #2a2a3c;
            border: 1px solid #444;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
        }

        input:focus {
            outline: none;
            border-color: #AF69EE;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: #AF69EE;
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            margin: 10px 0;
            cursor: pointer;
        }

        button:hover {
            background-color: #9a5ad6;
        }

        .class-list {
            display: none;
        }

        .class-item {
            background-color: #2a2a3c;
            margin: 10px 0;
            padding: 15px;
            border-radius: 25px;
            border: 1px solid #444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 20;
        }

        .modal-content {
            background-color: #2a2a3c;
            margin: 20% auto;
            padding: 20px;
            width: 80%;
            border-radius: 20px;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <!-- App Bar -->
    <div class="app-bar">
        <div class="logo">S</div>
        <div class="title">Substitute</div>
        <div class="menu-btn" onclick="showInfo()">&#x22EE;</div>
    </div>

    <!-- Content -->
    <div class="content">
        <div id="tab-vplan" class="tab-content">
            <div id="login-form" class="form-container">
                <h2>VPlan Anmeldedaten</h2>
                <input type="number" id="schoolnumber" placeholder="Schulnummer">
                <input type="text" id="username" placeholder="Benutzername">
                <input type="password" id="password" placeholder="Passwort">
                <input type="url" id="customUrl" placeholder="Benutzerdefinierte URL (optional)" style="display: none;">
                <button onclick="toggleCustomUrl()">Benutzerdefinierte URL verwenden</button>
                <button onclick="saveCredentials()">Speichern</button>
                <button onclick="loadClasses()">Klassen laden</button>
            </div>

            <div id="class-list-container" class="class-list">
                <h2>Wähle eine Klasse</h2>
                <div id="class-list"></div>
            </div>
        </div>

        <div id="tab-teacher" class="tab-content" style="display: none;">
            <div class="form-container">
                <h2>Lehrerverwaltung</h2>
                <p>Hier können Lehrerkürzel verwaltet werden</p>
                <button onclick="loadTeachers()">Lehrer laden</button>
                <div id="teacher-list" class="class-list"></div>
            </div>
        </div>



        <div id="tab-freerooms" class="tab-content" style="display: none;">
            <div class="form-container">
                <h2>Freie Räume</h2>
                <p>Wähle einen Tag und eine Zeit, um freie Räume zu finden.</p>
                <input type="date" id="freerooms-date">
                <input type="time" id="freerooms-time">
                <button onclick="findFreeRooms()">Suchen</button>
                <div id="freerooms-list" class="class-list"></div>
            </div>
        </div>




        <!-- Room Details Modal -->
        <div id="room-details-modal" class="modal" onclick="closeModal()">
            <div class="modal-content" onclick="event.stopPropagation()">
                <h2 id="room-details-title">Raum Details</h2>
                <div id="room-details-content"></div>
                <button onclick="closeModal()">Schließen</button>
            </div>
        </div>

        <div id="tab-dashboard" class="tab-content" style="display: none;">
            <div class="form-container">
                <h2>Dashboard</h2>
                <button onclick="showSettings()">Zugangsdaten ändern</button>
                <button onclick="showAnalytics()">Analysen anzeigen</button>
                <button onclick="forceRefreshData()">Force Refresh Data</button>
                <button onclick="clearData()">Daten löschen</button>
                <div id="dashboard-info"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="setTab(0)">
            <div class="nav-icon">&#xE88A;</div>
            <div>VPlan</div>
        </div>
        <div class="nav-item" onclick="setTab(1)">
            <div class="nav-icon">&#xE7EF;</div>
            <div>Lehrer</div>
        </div>

        <div class="nav-item" onclick="setTab(2)">
            <div class="nav-icon">&#xE572;</div>
            <div>Freie Räume</div>
        </div>
        <div class="nav-item" onclick="setTab(3)">
            <div class="nav-icon">&#xE871;</div>
            <div>Dashboard</div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2>App Info</h2>
            <p>Substitute - Vertretungsplan App</p>
            <button onclick="closeModal()">Schließen</button>
        </div>
    </div>

    <script>
        let cachedXmlData = ''; // Cache for the fetched XML data for the current day
        let cachedTeacherList = []; // Cache for the teacher list
        
        // --- State for Date Navigation ---
        let currentDate = new Date();
        let currentView = { type: null, name: null }; // Tracks what is being viewed, e.g., { type: 'class', name: '10A' }

        // Load saved credentials on page load
        window.onload = function() {
            loadCredentials();
            const favoriteClass = localStorage.getItem('favoriteClass');
            const schoolnumber = localStorage.getItem('vplanSchoolnumber');

            if (favoriteClass && schoolnumber) {
                loadPlanForFavoriteClass(favoriteClass);
            }
        };

        async function loadPlanForFavoriteClass(className) {
            const schoolnumber = localStorage.getItem('vplanSchoolnumber');
            const username = localStorage.getItem('vplanUsername');
            const password = localStorage.getItem('vplanPassword');
            const customUrl = localStorage.getItem('customUrl');

            try {
                const proxy = 'https://corsproxy.io/?';
                let url;
                let headers = {};

                if (customUrl) {
                    url = `${proxy}${customUrl}Klassen.xml`;
                } else {
                    url = `${proxy}https://www.stundenplan24.de/${schoolnumber}/mobil/mobdaten/Klassen.xml`;
                    const credentials = btoa(`${username}:${password}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }

                const response = await fetch(url, { method: 'GET', headers: headers });

                if (!response.ok) {
                    document.getElementById('login-form').style.display = 'block';
                    return;
                }

                const xmlText = await response.text();
                cachedXmlData = xmlText; // Cache the data

                const { lessons, planDate } = parseLessons(cachedXmlData, className);
                displayLessons(lessons, planDate); 
                
                document.getElementById('class-list-container').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';

            } catch (error) {
                console.error('Error auto-loading favorite class plan:', error);
                document.getElementById('login-form').style.display = 'block';
            }
        }

        function loadCredentials() {
            const schoolnumber = localStorage.getItem('vplanSchoolnumber');
            const username = localStorage.getItem('vplanUsername');
            const password = localStorage.getItem('vplanPassword');
            const customUrl = localStorage.getItem('customUrl');

            if (schoolnumber) document.getElementById('schoolnumber').value = schoolnumber;
            if (username) document.getElementById('username').value = username;
            if (password) document.getElementById('password').value = password;
            if (customUrl) document.getElementById('customUrl').value = customUrl;
        }

        function saveCredentials() {
            const schoolnumber = document.getElementById('schoolnumber').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const customUrl = document.getElementById('customUrl').value;

            localStorage.setItem('vplanSchoolnumber', schoolnumber);
            localStorage.setItem('vplanUsername', username);
            localStorage.setItem('vplanPassword', password);
            localStorage.setItem('customUrl', customUrl);

            alert('Anmeldedaten gespeichert!');
        }

        function toggleCustomUrl() {
            const customUrlInput = document.getElementById('customUrl');
            const isVisible = customUrlInput.style.display !== 'none';
            customUrlInput.style.display = isVisible ? 'none' : 'block';
        }

        async function loadClasses(forceRefresh = false) {
            const schoolnumber = document.getElementById('schoolnumber').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const customUrl = document.getElementById('customUrl').value;

            if (!schoolnumber || (!username && !password && !customUrl)) {
                alert('Bitte füllen Sie die Anmeldedaten aus!');
                return;
            }

            const cachedClasses = localStorage.getItem('cachedClasses');
            if (cachedClasses && !forceRefresh) {
                const classList = JSON.parse(cachedClasses);
                displayClasses(classList);
                document.getElementById('class-list-container').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';
                return;
            }

            try {
                const proxy = 'https://corsproxy.io/?';
                let url;
                let headers = {};

                if (customUrl) {
                    url = `${proxy}${customUrl}Klassen.xml`;
                } else {
                    url = `${proxy}https://www.stundenplan24.de/${schoolnumber}/mobil/mobdaten/Klassen.xml`;
                    const credentials = btoa(`${username}:${password}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

        const xmlText = await response.text();
        cachedXmlData = xmlText; // Cache the XML data
        const classList = await parseClasses(xmlText);
        localStorage.setItem('cachedClasses', JSON.stringify(classList)); // Save classes to localStorage

        displayClasses(classList);

                document.getElementById('class-list-container').style.display = 'block';
                document.getElementById('login-form').style.display = 'none';

            } catch (error) {
                alert('Fehler beim Laden der Klassen: ' + error.message);
                console.error('Error loading classes:', error);
            }
        }

        function parseClasses(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const classes = xmlDoc.querySelectorAll('Kl');
            const classList = [];

            classes.forEach(cls => {
                const kurz = cls.querySelector('Kurz')?.textContent;
                if (kurz) {
                    classList.push(kurz);
                }
            });

            return classList;
        }

        function displayClasses(classList) {
            const classListElement = document.getElementById('class-list');
            classListElement.innerHTML = '';

            classList.forEach(className => {
                const classItem = document.createElement('div');
                classItem.className = 'class-item';
                classItem.innerHTML = `
                    <strong>${className}</strong>
                    <div>Klick für Details</div>
                `;
                classItem.onclick = () => loadClassDetails(className);
                classListElement.appendChild(classItem);
            });
        }

        async function loadClassDetails(className, fromDateChange = false) {
            localStorage.setItem('favoriteClass', className);

            if (!fromDateChange) {
                currentDate = new Date(); // Reset to today when a new class is selected
            }
            currentView = { type: 'class', name: className };
            
            // For today, use the cached main XML if available. For other days, always fetch.
            if (isToday(currentDate) && cachedXmlData) {
                const { lessons, planDate } = parseLessons(cachedXmlData, className);
                displayLessons(lessons, planDate || formatDateForDisplay(currentDate));
                return;
            }

            try {
                const xmlText = await fetchPlanForDate(currentDate);
                if (xmlText) {
                    const { lessons, planDate } = parseLessons(xmlText, className);
                    displayLessons(lessons, planDate || formatDateForDisplay(currentDate));
                } else {
                    displayLessons([], formatDateForDisplay(currentDate)); // Show empty plan if no data
                }
            } catch (error) {
                console.error('Fehler beim Laden der Plandaten für dieses Datum: ', error);
                displayLessons([], formatDateForDisplay(currentDate)); // Show empty plan on error
            }
        }

        function getCurrentDateYYYYMMDD() {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function parseLessons(xmlText, className) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const kopf = xmlDoc.querySelector('Kopf');
            const planDate = kopf?.querySelector('DatumPlan')?.textContent;

            const classes = xmlDoc.querySelectorAll('Kl');

            for (let i = 0; i < classes.length; i++) {
                const kurz = classes[i].querySelector('Kurz');
                if (kurz && kurz.textContent === className) {
                    const stunden = classes[i].querySelectorAll('Std');
                    const lessons = [];

                    stunden.forEach(std => {
                        const st = std.querySelector('St')?.textContent;
                        const fa = std.querySelector('Fa')?.textContent;
                        const regel = std.querySelector('If')?.textContent;
                        const beginn = std.querySelector('Beginn')?.textContent;
                        const ende = std.querySelector('Ende')?.textContent;
                        const ra = std.querySelector('Ra')?.textContent;
                        const le = std.querySelector('Le')?.textContent;

                        if (st && fa) {
                            lessons.push({
                                stunde: st,
                                fach: fa,
                                regel: regel,
                                beginn: beginn || '',
                                ende: ende || '',
                                raum: ra || '',
                                lehrer: le || ''
                            });
                        }
                    });

                    return { lessons: lessons, planDate: planDate };
                }
            }

            return { lessons: [], planDate: planDate };
        }

        function displayLessons(lessons, dateString, className) {
            const container = document.getElementById('class-list-container');
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                    <button onclick="changeDay(-1, '${className}')" style="font-size: 24px; background: none; border: none; color: #AF69EE; cursor: pointer;"><</button>
                    <h3 style="margin: 0; text-align: center;">${dateString}</h3>
                    <button onclick="changeDay(1, '${className}')" style="font-size: 24px; background: none; border: none; color: #AF69EE; cursor: pointer;">></button>
                </div>
                <div id="lessons"></div>
                <button onclick="backToClasses()">Zurück zur Klassenübersicht</button>
            `;

            const lessonsElement = document.getElementById('lessons');

            if (lessons.length === 0) {
                lessonsElement.innerHTML = '<p>Für diesen Tag sind keine Informationen verfügbar</p>';
                return;
            }

            lessons.forEach(lesson => {
                const lessonItem = document.createElement('div');
                lessonItem.className = 'class-item';
        lessonItem.innerHTML = `
            <strong>Stunde ${lesson.stunde}: ${lesson.fach}</strong>
            <div>Lehrer: ${lesson.lehrer}</div>
            <div>Raum: ${lesson.raum}</div>
            <div>Zeit: ${lesson.beginn} - ${lesson.ende}</div>
            <div>${lesson.regel ? 'Info: ' + lesson.regel : ''}</div>
        `;
                lessonsElement.appendChild(lessonItem);
            });
        }

        function backToClasses() {
            document.getElementById('class-list-container').innerHTML = `
                <h2>Wähle eine Klasse</h2>
                <div id="class-list"></div>
            `;
            if (cachedXmlData) {
                const classList = parseClasses(cachedXmlData);
                displayClasses(classList);
            } else {
                // Fallback if cache is empty for some reason
                document.getElementById('login-form').style.display = 'block';
                document.getElementById('class-list-container').style.display = 'none';
            }
        }

        function setTab(tabIndex) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.style.display = 'none');

            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            navItems[tabIndex].classList.add('active');

            const tabIds = ['tab-vplan', 'tab-teacher', 'tab-freerooms', 'tab-dashboard'];
            document.getElementById(tabIds[tabIndex]).style.display = 'block';

            // Pre-fill date and time and auto-load teachers/freerooms when switching tabs
            if (tabIndex === 1) {
                const cachedTeachers = localStorage.getItem('cachedTeachers');
                if (cachedTeachers) {
                    const teacherList = JSON.parse(cachedTeachers);
                    cachedTeacherList = teacherList;
                    displayTeachers(teacherList);
                }
            }
            if (tabIndex === 3) {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');

                const dateInput = document.getElementById('freerooms-date');
                if (!dateInput.value) {
                    dateInput.value = `${year}-${month}-${day}`;
                }

                const timeInput = document.getElementById('freerooms-time');
                if (!timeInput.value) {
                    timeInput.value = `${hours}:${minutes}`;
                }
            }
        }

        async function loadTeachers(forceRefresh = false) {
            const schoolnumber = document.getElementById('schoolnumber').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const customUrl = document.getElementById('customUrl').value;

            if (!schoolnumber || (!username && !password && !customUrl)) {
                alert('Bitte füllen Sie die Anmeldedaten aus!');
                return;
            }

            const cachedTeachers = localStorage.getItem('cachedTeachers');
            if (cachedTeachers && !forceRefresh) {
                const teacherList = JSON.parse(cachedTeachers);
                cachedTeacherList = teacherList;
                displayTeachers(teacherList);
                return;
            }

            try {
                const proxy = 'https://corsproxy.io/?';
                let url;
                let headers = {};

                if (customUrl) {
                    url = `${proxy}${customUrl}Klassen.xml`;
                } else {
                    url = `${proxy}https://www.stundenplan24.de/${schoolnumber}/mobil/mobdaten/Klassen.xml`;
                    const credentials = btoa(`${username}:${password}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }

                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const xmlText = await response.text();
                // Ensure class XML is cached if teachers are loaded first
                if (!cachedXmlData) cachedXmlData = xmlText; 
                
                const teacherList = parseTeachers(xmlText);
                cachedTeacherList = teacherList; // Cache the teacher list in memory
                localStorage.setItem('cachedTeachers', JSON.stringify(teacherList)); // Cache in localStorage
                displayTeachers(teacherList);

            } catch (error) {
                alert('Fehler beim Laden der Lehrer: ' + error.message);
                console.error('Error loading teachers:', error);
            }
        }

        function parseTeachers(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const kkzElements = xmlDoc.querySelectorAll('KKz');
            const teachers = new Set(); 

            kkzElements.forEach(kkz => {
                if (kkz.attributes.length > 0) {
                    const teacherShort = kkz.attributes[0].value;
                    if (teacherShort) {
                        teachers.add(teacherShort);
                    }
                }
            });

            return Array.from(teachers).sort();
        }

        function displayTeachers(teacherList) {
            const teacherListElement = document.getElementById('teacher-list');
            teacherListElement.innerHTML = '';

            teacherList.forEach(teacherName => {
                const teacherItem = document.createElement('div');
                teacherItem.className = 'class-item';
                teacherItem.style.cursor = 'pointer';
                teacherItem.innerHTML = `<strong>${teacherName}</strong>`;
                teacherItem.onclick = () => loadTeacherDetails(teacherName);
                teacherListElement.appendChild(teacherItem);
            });

            teacherListElement.style.display = 'block';
        }

        async function loadTeacherDetails(teacherName, fromDateChange = false) {
            if (!fromDateChange) {
                currentDate = new Date(); // Reset to today
            }
            currentView = { type: 'teacher', name: teacherName };

            if (isToday(currentDate) && !cachedXmlData) {
                alert('Bitte zuerst auf dem VPlan-Tab die Klassen laden, um die heutigen Daten zu erhalten.');
                return;
            }

            try {
                const xmlText = isToday(currentDate) ? cachedXmlData : await fetchPlanForDate(currentDate);
                if (xmlText) {
                    const lessons = parseTeacherLessons(xmlText, teacherName);
                    displayTeacherLessons(teacherName, lessons, formatDateForDisplay(currentDate));
                } else {
                    displayTeacherLessons(teacherName, [], formatDateForDisplay(currentDate));
                }
            } catch (error) {
                console.error('Fehler beim Laden der Lehrerplandaten: ', error);
                displayTeacherLessons(teacherName, [], formatDateForDisplay(currentDate));
            }
        }

        function parseTeacherLessons(xmlText, teacherName) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const classes = xmlDoc.querySelectorAll('Kl');
            const lessons = [];

            classes.forEach(cls => {
                const className = cls.querySelector('Kurz')?.textContent;
                const stunden = cls.querySelectorAll('Std');

                stunden.forEach(std => {
                    const lehrer = std.querySelector('Le')?.textContent;

                    if (lehrer && lehrer.trim() === teacherName.trim()) {
                        const st = std.querySelector('St')?.textContent;
                        const fa = std.querySelector('Fa')?.textContent;
                        const regel = std.querySelector('If')?.textContent;
                        const beginn = std.querySelector('Beginn')?.textContent;
                        const ende = std.querySelector('Ende')?.textContent;
                        const ra = std.querySelector('Ra')?.textContent;

                        if (st && fa) {
                            lessons.push({
                                klasse: className,
                                stunde: st,
                                fach: fa,
                                regel: regel || '',
                                beginn: beginn || '',
                                ende: ende || '',
                                raum: ra || '',
                                lehrer: lehrer
                            });
                        }
                    }
                });
            });
            lessons.sort((a, b) => a.stunde.localeCompare(b.stunde));
            return lessons;
        }

        function displayTeacherLessons(teacherName, lessons, dateString) {
            const container = document.getElementById('teacher-list').parentElement;
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0 10px;">
                    <button onclick="changeDay(-1, '${teacherName}')" style="font-size: 24px; background: none; border: none; color: #AF69EE; cursor: pointer;"><</button>
                    <h3 style="margin: 0; text-align: center;">Plan für ${teacherName}<br><small>${dateString}</small></h3>
                    <button onclick="changeDay(1, '${teacherName}')" style="font-size: 24px; background: none; border: none; color: #AF69EE; cursor: pointer;">></button>
                </div>
                <div id="teacher-lessons"></div>
                <button onclick="backToTeachers()">Zurück zur Lehrerliste</button>
            `;

            const lessonsElement = document.getElementById('teacher-lessons');

            if (lessons.length === 0) {
                lessonsElement.innerHTML = '<p>Für diesen Tag sind keine Informationen verfügbar</p>';
                return;
            }

            lessons.forEach(lesson => {
                const lessonItem = document.createElement('div');
                lessonItem.className = 'class-item';
                lessonItem.innerHTML = `
                    <strong>Klasse ${lesson.klasse}, Stunde ${lesson.stunde}: ${lesson.fach}</strong>
                    <div>Raum: ${lesson.raum}</div>
                    <div>Zeit: ${lesson.beginn} - ${lesson.ende}</div>
                    <div>${lesson.regel ? 'Info: ' + lesson.regel : ''}</div>
                `;
                lessonsElement.appendChild(lessonItem);
            });
        }

        function backToTeachers() {
            const container = document.getElementById('tab-teacher').querySelector('.form-container');
            container.innerHTML = `
                <h2>Lehrerverwaltung</h2>
                <p>Hier können Lehrerkürzel verwaltet werden</p>
                <button onclick="loadTeachers()">Lehrer laden</button>
                <div id="teacher-list" class="class-list"></div>
            `;
            displayTeachers(cachedTeacherList);
        }

        function showSettings() {
            setTab(0);
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('class-list-container').style.display = 'none';
        }

        // --- Date Navigation Helper Functions ---

        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }
        
        function formatDateForURL(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('de-DE', { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function changeDay(offset, name) {
            currentDate.setDate(currentDate.getDate() + offset);
            
            if (offset > 0 && currentDate.getDay() === 6) currentDate.setDate(currentDate.getDate() + 2);
            if (offset > 0 && currentDate.getDay() === 0) currentDate.setDate(currentDate.getDate() + 1);
            if (offset < 0 && currentDate.getDay() === 0) currentDate.setDate(currentDate.getDate() - 2);
            if (offset < 0 && currentDate.getDay() === 6) currentDate.setDate(currentDate.getDate() - 1);

            if (currentView.type === 'class') {
                loadClassDetails(name, true);
            } else if (currentView.type === 'teacher') {
                loadTeacherDetails(name, true);
            }
        }

        async function fetchPlanForDate(date) {
            const schoolnumber = document.getElementById('schoolnumber').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const customUrl = document.getElementById('customUrl').value;
            
            const dateUrlPart = `PlanKl${formatDateForURL(date)}.xml`;
            
            try {
                const proxy = 'https://corsproxy.io/?';
                let url;
                let headers = {};

                if (customUrl) {
                    url = `${proxy}${customUrl}${dateUrlPart}`;
                } else {
                    url = `${proxy}https://www.stundenplan24.de/${schoolnumber}/mobil/mobdaten/${dateUrlPart}`;
                    const credentials = btoa(`${username}:${password}`);
                    headers['Authorization'] = `Basic ${credentials}`;
                }

                const response = await fetch(url, { method: 'GET', headers: headers });

                if (response.status === 404) {
                    return null; // No plan for this day, not an error
                }
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.text();

            } catch (error) {
                console.error(`Error fetching plan for ${formatDateForDisplay(date)}:`, error);
                throw error; // Rethrow to be caught by the caller
            }
        }

        function showAnalytics() {
            const info = document.getElementById('dashboard-info');
            const savedSchool = localStorage.getItem('vplanSchoolnumber');
            info.innerHTML = `
                <div class="class-item">
                    <strong>Analytics Dashboard</strong>
                    <div>Gespeicherte Schulnummer: ${savedSchool || 'Keine'}</div>
                    <div>Zuletzt verwendet: ${new Date().toLocaleDateString()}</div>
                    <div>API-Status: ${savedSchool ? 'Bereit' : 'Nicht konfiguriert'}</div>
                </div>
            `;
        }

        function clearData() {
            if (confirm('Alle gespeicherten Daten löschen?')) {
                localStorage.clear();
                location.reload();
            }
        }

        function showInfo() {
            document.getElementById('info-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('info-modal').style.display = 'none';
            document.getElementById('room-details-modal').style.display = 'none';
        }



        function forceRefreshData() {
            localStorage.removeItem('cachedClasses');
            localStorage.removeItem('cachedTeachers');
            cachedXmlData = '';
            alert('Cache cleared. Please reload the data.');
        }

        function selectDate() {
            const dateInput = document.getElementById('freerooms-date');
            if (typeof dateInput.showPicker === 'function') {
                dateInput.showPicker();
            } else {
                // Fallback: make input visible and click it
                dateInput.style.display = 'block';
                dateInput.focus();
                dateInput.click();
            }
        }

        function selectTime() {
            const timeInput = document.getElementById('freerooms-time');
            if (typeof timeInput.showPicker === 'function') {
                timeInput.showPicker();
            } else {
                // Fallback: make input visible and click it
                timeInput.style.display = 'block';
                timeInput.focus();
                timeInput.click();
            }
        }

        function showFreeRooms() {
            setTab(3);
        }

        async function findFreeRooms() {
            const date = document.getElementById('freerooms-date').value;
            const time = document.getElementById('freerooms-time').value;

            if (!date || !time) {
                alert('Bitte wähle ein Datum und eine Uhrzeit.');
                return;
            }

            const selectedDateTime = new Date(`${date}T${time}`);
            const xmlText = await fetchPlanForDate(selectedDateTime);

            if (!xmlText) {
                alert('Kein Plan für das ausgewählte Datum verfügbar.');
                return;
            }

            const { freeRooms, occupiedRooms } = parseRoomStatus(xmlText, selectedDateTime);
            displayFreeRooms(freeRooms, occupiedRooms);
        }

        function parseRoomStatus(xmlText, selectedTime) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const classes = xmlDoc.querySelectorAll('Kl');
            const allRooms = new Set();
            const occupiedRooms = new Set();

            // Extract all unique numeric rooms from the plan
            classes.forEach(cls => {
                const stunden = cls.querySelectorAll('Std');
                stunden.forEach(std => {
                    const room = std.querySelector('Ra')?.textContent;
                    if (room && room.trim() !== '---' && room.trim() !== 'Gang') {
                        // Clean room name like in the app (remove prefixes H1, H2, H3, E)
                        let editRoom = room.replace(/H[123]|E/g, '');
                        if (/^\d+$/.test(editRoom)) { // Check if it's a numeric room
                            allRooms.add(parseInt(editRoom));
                        }
                    }
                });
            });

            // Determine which rooms are occupied at the selected time
            classes.forEach(cls => {
                const stunden = cls.querySelectorAll('Std');
                stunden.forEach(std => {
                    const beginn = std.querySelector('Beginn')?.textContent;
                    const ende = std.querySelector('Ende')?.textContent;
                    const room = std.querySelector('Ra')?.textContent;

                    if (beginn && ende && room) {
                        // Clean room name
                        let editRoom = room.replace(/H[123]|E/g, '');
                        if (/^\d+$/.test(editRoom)) {
                            const roomNum = parseInt(editRoom);

                            // Create Date objects for comparison
                            const lessonStart = new Date(`${selectedTime.toDateString()} ${beginn}`);
                            const lessonEnd = new Date(`${selectedTime.toDateString()} ${ende}`);

                            // Check if the selected time falls within the lesson's duration
                            if (selectedTime >= lessonStart && selectedTime < lessonEnd) {
                                occupiedRooms.add(roomNum);
                            }
                        }
                    }
                });
            });

            const freeRooms = [...allRooms].filter(room => !occupiedRooms.has(room)).sort((a, b) => a - b);
            const occupiedRoomsArray = [...occupiedRooms].sort((a, b) => a - b);

            return { freeRooms, occupiedRooms: occupiedRoomsArray };
        }

        function displayFreeRooms(freeRooms, occupiedRooms) {
            const freeRoomsList = document.getElementById('freerooms-list');
            freeRoomsList.innerHTML = '';

            if (freeRooms.length > 0) {
                freeRoomsList.innerHTML += '<h3>Freie Räume</h3>';
                freeRooms.forEach(room => {
                    const roomItem = document.createElement('div');
                    roomItem.className = 'class-item';
                    roomItem.style.borderColor = '#AF69EE';
                    roomItem.style.borderWidth = '2px';
                    roomItem.style.cursor = 'pointer';
                    roomItem.innerHTML = `<strong>${room}</strong>`;
                    roomItem.onclick = () => showRoomDetails(room);
                    freeRoomsList.appendChild(roomItem);
                });
            } else {
                freeRoomsList.innerHTML += '<h3>Keine freien Räume verfügbar</h3>';
            }

            if (occupiedRooms.length > 0) {
                freeRoomsList.innerHTML += '<h3>Besetzte Räume</h3>';
                occupiedRooms.forEach(room => {
                    const roomItem = document.createElement('div');
                    roomItem.className = 'class-item';
                    roomItem.style.cursor = 'pointer';
                    roomItem.innerHTML = `<strong>${room}</strong>`;
                    roomItem.onclick = () => showRoomDetails(room);
                    freeRoomsList.appendChild(roomItem);
                });
            }

            freeRoomsList.style.display = 'block';
        }

        function showRoomDetails(roomNumber) {
            const date = document.getElementById('freerooms-date').value;
            const time = document.getElementById('freerooms-time').value;

            if (!date || !time) {
                alert('Bitte wähle ein Datum und eine Uhrzeit.');
                return;
            }

            const selectedDateTime = new Date(`${date}T${time}`);
            fetchPlanForDate(selectedDateTime).then(xmlText => {
                if (!xmlText) {
                    alert('Kein Plan für das ausgewählte Datum verfügbar.');
                    return;
                }

                const roomLessons = parseRoomDetails(xmlText, roomNumber, selectedDateTime);
                displayRoomDetails(roomNumber, roomLessons);
            }).catch(error => {
                console.error('Fehler beim Laden der Raumdetails:', error);
                alert('Fehler beim Laden der Raumdetails.');
            });
        }

        function parseRoomDetails(xmlText, roomNumber, selectedTime) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            const classes = xmlDoc.querySelectorAll('Kl');
            const lessons = [];

            classes.forEach(cls => {
                const className = cls.querySelector('Kurz')?.textContent;
                const stunden = cls.querySelectorAll('Std');

                stunden.forEach(std => {
                    const beginn = std.querySelector('Beginn')?.textContent;
                    const ende = std.querySelector('Ende')?.textContent;
                    const room = std.querySelector('Ra')?.textContent;
                    const st = std.querySelector('St')?.textContent;
                    const fa = std.querySelector('Fa')?.textContent;
                    const le = std.querySelector('Le')?.textContent;
                    const regel = std.querySelector('If')?.textContent;

                    if (room && beginn && ende) {
                        // Clean room name
                        let editRoom = room.replace(/H[123]|E/g, '');
                        if (/^\d+$/.test(editRoom) && parseInt(editRoom) === roomNumber) {

                            // Create Date objects for comparison
                            const lessonStart = new Date(`${selectedTime.toDateString()} ${beginn}`);
                            const lessonEnd = new Date(`${selectedTime.toDateString()} ${ende}`);

                            // Check if the selected time falls within the lesson's duration
                            if (selectedTime >= lessonStart && selectedTime < lessonEnd) {
                                lessons.push({
                                    klasse: className,
                                    stunde: parseInt(st),
                                    fach: fa,
                                    lehrer: le,
                                    beginn: beginn,
                                    ende: ende,
                                    regel: regel || ''
                                });
                            }
                        }
                    }
                });
            });

            lessons.sort((a, b) => a.stunde - b.stunde);
            return lessons;
        }

        function displayRoomDetails(roomNumber, lessons) {
            document.getElementById('room-details-title').textContent = `Raum ${roomNumber} Details`;
            const detailsContent = document.getElementById('room-details-content');

            if (lessons.length === 0) {
                detailsContent.innerHTML = '<p>Zu diesem Zeitpunkt findet keine Unterrichtsstunde in diesem Raum statt.</p>';
            } else {
                detailsContent.innerHTML = `<p>Folgende Unterrichtsstunden finden statt:</p>`;
                lessons.forEach(lesson => {
                    const lessonItem = document.createElement('div');
                    lessonItem.className = 'class-item';
                    lessonItem.innerHTML = `
                        <strong>Stunde ${lesson.stunde}: ${lesson.fach}</strong>
                        <div>Klasse: ${lesson.klasse}</div>
                        <div>Lehrer: ${lesson.lehrer}</div>
                        <div>Zeit: ${lesson.beginn} - ${lesson.ende}</div>
                        ${lesson.regel ? `<div>Info: ${lesson.regel}</div>` : ''}
                    `;
                    detailsContent.appendChild(lessonItem);
                });
            }

            document.getElementById('room-details-modal').style.display = 'block';
        }
    </script>
</body>
</html>
